# AutoButtonTracking ‚Äì Architectural Design & Rollout Plan

**Status:** Approved for implementation
**Owner:** Web Platform / Analytics
**Last updated:** 2025‚Äë08‚Äë19

---

## 1) Executive Summary

**AutoButtonTracking** adds zero‚Äëboilerplate click and conversion analytics to all UI buttons via a single, stable, document‚Äëlevel listener. It preserves a presentation‚Äëonly `<Button>` component (SSR‚Äëfriendly) while providing robust, privacy‚Äëaware telemetry that works for native buttons and `asChild` links, across SPA navigation, middle/modified clicks, Shadow DOM/portals, and disabled states. The system is vendor‚Äëagnostic via a `useAnalytics()` provider contract and ships with strict PII guards, consent awareness, and defensive error handling.

**Why now?** Most buttons require tracking; wrappers add maintenance overhead and regressions. Event delegation yields consistent coverage with minimal risk.

---

## 2) Goals & Non‚ÄëGoals

**Goals**

* One‚Äëtime mount; no per‚Äëbutton code or wrappers.
* Accurate click attribution for primary, middle, and modified clicks, including SPA `<Link>` navigation where `preventDefault()` is used.
* Optional conversion firing on click or manually after async success.
* Type‚Äë and privacy‚Äësafe context including size/variant/position and stable IDs.
* Consent‚Äërespecting and resilient: analytics failures never break UX.

**Non‚ÄëGoals**

* Tracking of right‚Äëclick context menu interactions.
* Automatic tracking of non‚Äëbutton elements (menus, inputs, etc.).
* Page view tracking or non‚Äëinteraction telemetry (handled elsewhere).

---

## 3) High‚ÄëLevel Design

### 3.1 Architecture

* **Base UI primitive**: `<Button>` remains SSR/presentational, exposing semantic attributes only: `data-slot="button"`, `data-variant`, `data-size`.
* **Global listener**: `<AutoButtonTracking/>` is a small client component mounted once in the root layout. It attaches a document‚Äëlevel `click` and `auxclick` listener (passive), uses event delegation to find the nearest `[data-slot="button"]`, and sends analytics via `useAnalytics()`.
* **Configuration**: Lightweight compile‚Äëtime knobs (constants/env) to control page granularity, dedupe windows, context caps, and query‚Äëparam scrubbing.
* **Provider abstraction**: `useAnalytics()` surfaces `trackButtonClick`, `trackConversion`, and optional `isEnabled()`; different environments swap providers (Console, GA4, Ads, Disabled), keeping vendor lock‚Äëin out of UI code.

### 3.2 Data Flow (click path)

1. User clicks anywhere in the document.
2. Listener resolves the target button element (Shadow DOM safe via `event.composedPath()` + `closest("[data-slot='button']")`).
3. Guards run (trusted event, not disabled/fieldset‚Äëdisabled, not opted‚Äëout, deduped).
4. Name inferred (`data-analytics-name` ‚Üí `aria-labelledby` ‚Üí `aria-label` ‚Üí innerText/textContent).
5. Page computed using `PAGE_MODE` with query‚Äëparam hygiene (drops UTMs, `*clid`, and PII‚Äëlike values).
6. Context assembled from dataset (`button_id`, `position`, `size`, `variant`, `open_in_new_tab`) + parsed JSON; sanitized (null‚Äëprototype, reserved‚Äëkey guard, PII filters, value truncation, key cap).
7. `trackButtonClick(name, page, context)` invoked (try/catch).
8. If configured (`data-conversion-*` + `conversion_fire=onClick`), `trackConversion(...)` invoked (try/catch).

### 3.3 Conversion Triggers

* **On click:** Set `data-conversion-id`, `data-conversion-label`, optional `value`, `currency`, `conversion_params` JSON.
* **Manual (async success):** Mark element with `data-conversion-fire="manual"`; call `trackConversion(...)` when the operation completes.

---

## 4) Public Interfaces

### 4.1 Element‚Äëlevel configuration (data attributes)

* `data-analytics-id` ‚Äî **stable ID** for dashboards/experiments (e.g., `pricing_cta`).
* `data-analytics-name` ‚Äî human label (defaults to inferred).
* `data-analytics-enabled="false"` ‚Äî opt‚Äëout for a given element.
* `data-analytics-page` ‚Äî override page string (default per `PAGE_MODE`).
* `data-analytics-context` ‚Äî JSON map (sanitized & flattened one level).
* `data-button-position` ‚Äî free‚Äëform (e.g., `hero`, `footer`).
* **Conversion:** `data-conversion-id`, `data-conversion-label`, `data-conversion-value`, `data-conversion-currency`, `data-conversion-params`, `data-conversion-fire="onClick|manual"`.

### 4.2 Provider contract (minimal)

```ts
interface AnalyticsProvider {
  trackButtonClick(name: string, page?: string, ctx?: Record<string, unknown>): void;
  trackConversion(payload: {
    conversion_id: string;
    conversion_label: string;
    value?: number; currency?: string;
    custom_parameters?: Record<string, unknown>;
  }): void;
  isEnabled?(): boolean; // Optional; consent gate
}
```

---

## 5) Detailed Behavior & Guards

* **Trusted events only:** Ignore programmatic `el.click()` via `event.isTrusted`.
* **Clicks handled:** Primary (`click`, `button===0`) and middle (`auxclick`, `button===1`), plus modified primary (`meta/ctrl/shift/alt`) interpreted as open‚Äëin‚Äënew.
* **Right‚Äëclicks:** Ignored by design; document in team footnotes.
* **Next.js `<Link>` SPA:** Track even if `preventDefault()` was called, **only** if the button is inside an anchor.
* **Disabled states:** Respect `disabled`, case‚Äënormalized `aria-disabled`, and `fieldset[disabled]` ancestry.
* **Shadow DOM & portals:** Use `event.composedPath()` to resolve the button across boundaries.
* **Dedupe:** Per‚Äëelement `WeakMap<HTMLElement, number>` with `DEDUPE_WINDOW_MS` (default 400ms).
* **Passive listeners:** `{ passive: true }` for a tiny perf win.
* **Page policy:** `PAGE_MODE="path+query"` by default with query scrubbing; configurable.
* **PII & safety:**

  * Sanitize context keys: regex whitelist, reserved‚Äëkey guard (`__proto__`, `prototype`, `constructor`).
  * Null‚Äëprototype output objects.
  * Drop email/phone‚Äëlike strings; cap string length to 200 chars.
  * Cap total context keys (`CONTEXT_KEY_CAP`, default 25).
* **Consent:** Use provider `isEnabled()` if present; providers also no‚Äëop under consent mode.
* **Resilience:** `try/catch` around analytics calls ensures no UI breakage.
* **Dev toggle:** `NEXT_PUBLIC_ANALYTICS_DEBUG=1` prints debug payloads.

---

## 6) Configuration & Defaults

* `PAGE_MODE: "path" | "path+query"` ‚Üí default `"path+query"` with hygiene.
* `DEDUPE_WINDOW_MS: number` ‚Üí default 400.
* `CONTEXT_KEY_CAP: number` ‚Üí default 25.
* `DROP_PARAMS: string[]` ‚Üí includes `utm_*`, `gclid`, `fbclid`, `msclkid`.
* `NEXT_PUBLIC_ANALYTICS_DEBUG: "0" | "1"` ‚Üí default `"0"`.

---

## 7) Performance Characteristics

* **Mount cost:** O(1); two passive listeners (click/auxclick).
* **Per‚Äëevent cost:** O(1) guards + small string ops; single JSON parse for optional context.
* **Memory:** Dedupe `WeakMap` ties lifetimes to DOM elements; no leaks.
* **No rebind churn:** Listener mounted once; latest provider fns kept via `ref`.

---

## 8) Security & Privacy Considerations

* Prototype‚Äëpollution protection via reserved‚Äëkey filtering and null‚Äëprototype objects.
* PII minimization (emails/phones) and query‚Äëparam scrubbing.
* Consent aware; safe to ship in strict GDPR/EEA modes.
* Analytics never throws into the app surface; exceptions swallowed after debug logging.

---

## 9) Accessibility

* Name inference prioritizes accessible labels (`aria-labelledby` > `aria-label` > visible text) and trims to 120 chars.
* Works for `asChild` links; ensures analytics even with SPA navigation.

---

## 10) Testing Strategy

**Unit (Jest/Vitest + RTL)**

* Trusted events: programmatic `click()` ignored.
* `<Link>` with `preventDefault()` still tracks when inside anchor.
* Disabled states: `disabled`, `aria-disabled`, and `fieldset[disabled]` do not track.
* Dedupe: two rapid clicks emit once (within window).
* Name inference: `aria-labelledby` > `aria-label` > text; trimmed.
* Context sanitation: drops PII‚Äëlike strings, reserved keys, caps keys and value length; null‚Äëprototype output.
* Query hygiene: UTMs/`*clid` and PII‚Äëlike values scrubbed.
* Provider throws: no uncaught errors; UI proceeds.

**E2E (Playwright)**

* SPA link navigation, middle/modified clicks, disabled/fieldset‚Äëdisabled, opt‚Äëout attribute.
* `open_in_new_tab` correctness.
* Shadow DOM (component library slotting) path resolution.

**Cross‚Äëbrowser checks**

* Safari middle‚Äëclick (auxclick best‚Äëeffort) + modified primary fallback.
* Chromium/Firefox standard behavior parity.

**Performance**

* Listener count stable across route changes.
* Cold/warm click latency negligible (<1ms handler body on typical hardware).

---

## 11) Observability & QA

* **Dev debug:** `NEXT_PUBLIC_ANALYTICS_DEBUG=1` logs payloads.
* **Console provider:** in dev/stage, surface payloads in devtools.
* **Dashboards:**

  * Button click event volume & unique users.
  * Top `button_id` and `name` (by page).
  * `open_in_new_tab` rate by CTA.
  * Conversion rate for CTAs configured with on‚Äëclick conversions.
* **Anomaly alerts:** sudden drop in total button clicks; per‚ÄëCTA alerts for marquee buttons.

---

## 12) Rollout Plan

**Time estimate:** \~1‚Äì2 hours for initial integration; same‚Äëday validation.

### Steps

1. **Mount once**: Add `<AutoButtonTracking/>` to root layout/providers.
2. **Mark marquee CTAs**: Add `data-analytics-id` to hero/pricing/checkout buttons; optional `data-button-position`.
3. **Decide page policy**: Keep `PAGE_MODE="path+query"` (default) or switch to `"path"`; confirm with analytics team.
4. **Providers**: Use console provider in dev/stage, GA4/Ads in prod; wire consent to `isEnabled()` if available.
5. **Debug toggle**: Set `NEXT_PUBLIC_ANALYTICS_DEBUG=1` in lower envs; validate payloads.
6. **E2E pass**: Validate SPA `<Link>` clicks, middle/modified clicks, disabled and fieldset‚Äëdisabled, and per‚Äëelement opt‚Äëout.
7. **Staged release**: Roll to a small percentage of traffic (if feasible) or to staging; watch dashboards for 24‚Äì48h.
8. **Production rollout**: Enable for all; keep debug off; keep alerts active.

### Acceptance criteria

* No console errors in production.
* Event volumes align with historical tracking (¬±10‚Äì15%) for comparable flows.
* All marquee CTAs report both `button_id` and `name` on expected pages.
* No reported navigation regressions (e.g., SPA link clicks).

### Rollback plan

* Feature‚Äëflag the component mount; unmount `<AutoButtonTracking/>` if anomalies.
* Providers can be switched to Disabled provider without code removal.

---

## 13) Risks & Mitigations

* **Over‚Äëcounting from synthetic events** ‚Üí Guard with `event.isTrusted` (done).
* **Missed SPA clicks due to `preventDefault()`** ‚Üí Track for anchors despite default prevented (done).
* **Payload bloat** ‚Üí Key/value caps and parameter scrubbing (done).
* **Prototype pollution via context JSON** ‚Üí Reserved‚Äëkey guard + null‚Äëprototype (done).
* **Auxclick Safari variance** ‚Üí Also treat modified primary clicks as new‚Äëtab (done).

---

## 14) Migration & Backward Compatibility

* Existing tracked wrappers may remain; they will still fire. Prefer removing wrappers over time to avoid double‚Äëcounting (wrap removal can be phased by route/feature flag).
* For manual conversions, no change required; continue calling `trackConversion(...)` on success paths.

---

## 15) Future Work (optional)

* **withTracking HOC** for non‚Äëbutton components (e.g., cards) while maintaining event delegation as the default.
* **Sampling** or **rate‚Äëlimit** for extremely high‚Äëfrequency elements (rare for buttons).
* **Auto‚Äënaming heuristics** using DOM ancestry (e.g., include nearest heading or section label) behind a flag.
* **Typed `data-analytics-context` schema** for common contexts (e.g., `experiment`, `variant`).

---

## 16) Appendix A ‚Äî Reference Implementation Notes

* Stable, passive listeners; single effect with empty deps (functions refreshed via `ref`).
* Per‚Äëelement `WeakMap` dedupe window (`400ms`).
* Query hygiene drops common trackers and PII‚Äëish values; configurable.
* Consent via `isEnabled()`; providers also enforce consent.
* Logs gated behind `NEXT_PUBLIC_ANALYTICS_DEBUG`.

---

## 17) ‚ÄúPin‚Äëit‚Äù Rollout Checklist

* [ ] Mount `<AutoButtonTracking/>` once (root layout/providers).
* [ ] Add `data-analytics-id` to hero/pricing/checkout CTAs.
* [ ] Confirm `PAGE_MODE` and `DROP_PARAMS` with analytics stakeholders.
* [ ] Dev/stage providers set; prod provider configured; consent wired.
* [ ] Enable debug in dev/stage; verify payloads.
* [ ] E2E: SPA `<Link>`, middle/modified clicks, disabled/fieldset‚Äëdisabled, opt‚Äëout.
* [ ] Dashboards & alerts in place; thresholds agreed.
* [ ] Progressive rollout or staging soak; then full prod.

---

**Decision:** Proceed. The design is production‚Äëgrade, low‚Äëmaintenance, and resilient with strong privacy/consent posture. Ship it. üöÄ
